# ローマ字読み上げモード 仕様書

## 1. 概要

本仕様書は、キーボード入力読み上げソフトウェアに日本語のローマ字読み上げモードを追加する機能の詳細仕様を定義します。

## 2. 機能概要

### 2.1 モード切替

- **切替キー**: `Ctrl + M`
- **モード**: 
  - アルファベットモード（既存機能）
  - ローマ字モード（新規追加）

### 2.2 モード表示

- 現在のモードをLCD画面に表示する
- モード切替時に視覚的フィードバックを提供する

## 3. ローマ字モードの動作仕様

### 3.1 状態遷移図

```
[初期状態]
    |
    | 母音入力 (a, i, u, e, o)
    | → 母音を読み上げ → [初期状態]
    |
    | 子音入力 (k, s, t, n, h, m, y, r, w, g, z, d, b, p, c, f, v, j, l, x)
    | → [子音待機状態]
    |
    | 'n'入力
    | → [n待機状態]

[子音待機状態]
    |
    | 母音入力
    | → ローマ字を読み上げ → [初期状態]
    |
    | 子音入力（別の子音）
    | → 最後の子音を新規入力として扱う → [子音待機状態]
    |
    | 'n'入力
    | → [n待機状態]

[n待機状態]
    |
    | 母音入力
    | → ローマ字を読み上げ（na→"な", ni→"に", nu→"ぬ", ne→"ね", no→"の"） → [初期状態]
    |
    | 子音入力
    | → "ん"を読み上げ → 子音を新規入力として扱う → [子音待機状態]
    |
    | 'n'入力
    | → "ん"を読み上げ → [n待機状態]
```

### 3.2 詳細動作

#### 3.2.1 初期状態

- **一文字目が母音の場合**:
  - 母音（a, i, u, e, o）をそのまま読み上げる
  - 初期状態に戻る

- **一文字目が子音の場合**:
  - 二打目の母音入力を待つ状態に遷移する
  - 読み上げは行わない

- **一文字目が'n'の場合**:
  - n待機状態に遷移する

#### 3.2.2 子音待機状態

- **母音が入力された場合**:
  - 保存された子音と入力された母音を組み合わせてローマ字を読み上げる
  - 例: k + a → "か", s + i → "し"
  - 初期状態に戻る

- **別の子音が入力された場合**:
  - 最後に入力された子音を新規の一打目として扱う
  - 子音待機状態を維持する
  - 例: k + s → sを新規入力として扱う

- **'n'が入力された場合**:
  - n待機状態に遷移する

#### 3.2.3 n待機状態

- **母音が入力された場合**:
  - 保存された'n'と入力された母音を組み合わせてローマ字を読み上げる
  - 例: n + a → "な", n + i → "に", n + u → "ぬ", n + e → "ね", n + o → "の"
  - 初期状態に戻る

- **子音が入力された場合**:
  - "ん"を読み上げる
  - 入力された子音を新規の一打目として扱う
  - 子音待機状態に遷移する
  - 例: n + k → "ん" + kを新規入力として扱う

- **'n'が再度入力された場合**:
  - "ん"を読み上げる
  - n待機状態を維持する

### 3.3 ローマ字対応表

#### 3.3.1 基本ローマ字

| ローマ字 | 読み | ローマ字 | 読み | ローマ字 | 読み |
|---------|------|---------|------|---------|------|
| ka | か | ki | き | ku | く | ke | け | ko | こ |
| sa | さ | si/shi | し | su | す | se | せ | so | そ |
| ta | た | ti/chi | ち | tu/tsu | つ | te | て | to | と |
| na | な | ni | に | nu | ぬ | ne | ね | no | の |
| ha | は | hi | ひ | fu/hu | ふ | he | へ | ho | ほ |
| ma | ま | mi | み | mu | む | me | め | mo | も |
| ya | や | - | - | yu | ゆ | - | - | yo | よ |
| ra | ら | ri | り | ru | る | re | れ | ro | ろ |
| wa | わ | - | - | - | - | - | - | wo | を |
| ga | が | gi | ぎ | gu | ぐ | ge | げ | go | ご |
| za | ざ | zi/ji | じ | zu | ず | ze | ぜ | zo | ぞ |
| da | だ | di/ji | ぢ | du/zu | づ | de | で | do | ど |
| ba | ば | bi | び | bu | ぶ | be | べ | bo | ぼ |
| pa | ぱ | pi | ぴ | pu | ぷ | pe | ぺ | po | ぽ |

#### 3.3.2 母音

| ローマ字 | 読み |
|---------|------|
| a | あ |
| i | い |
| u | う |
| e | え |
| o | お |

#### 3.3.3 特殊文字

| ローマ字 | 読み |
|---------|------|
| n | ん（条件付き） |

### 3.4 子音・母音の定義

#### 3.4.1 子音

以下の文字を子音として扱う:
- k, s, t, n, h, m, y, r, w, g, z, d, b, p, c, f, v, j, l, x

#### 3.4.2 母音

以下の文字を母音として扱う:
- a, i, u, e, o

#### 3.4.3 特殊文字

- **n**: 特殊な処理が必要（3.2.3参照）

## 4. 実装詳細

### 4.1 キーコード検出

#### 4.1.1 Ctrl+Mの検出

- HIDレポート構造:
  - `report[0]`: modifierキー（Ctrlはbit 0またはbit 4）
  - `report[2]`: キーコード（Mは0x10）

- 検出条件:
  - `report[0] & 0x01` (左Ctrl) または `report[0] & 0x10` (右Ctrl) が真
  - `report[2] == 0x10` (Mキー)

#### 4.2 状態管理

- グローバル変数で現在のモードを管理
- ローマ字モード時は、入力状態（初期/子音待機/n待機）を管理
- 子音待機状態では、最後に入力された子音を保存

### 4.3 音声ファイル

- ローマ字モード用の音声ファイルはSDカードに配置
- ファイル名形式: `/[ひらがな].wav`
- 例: `/か.wav`, `/し.wav`, `/ん.wav`

## 5. エッジケース

### 5.1 タイムアウト処理

- 子音待機状態やn待機状態で一定時間（例: 2秒）入力がない場合、状態をリセット
- または、次の入力で強制的に初期状態に戻す

### 5.2 無効な組み合わせ

- 存在しないローマ字組み合わせ（例: yi, ye, wi, we, wu）が入力された場合
- エラー音を再生するか、無視する

### 5.3 大文字・小文字

- アルファベット入力は小文字として扱う
- 大文字が入力された場合は小文字に変換して処理

## 6. テストケース

### 6.1 基本動作

1. **モード切替**
   - Ctrl+Mでアルファベットモード → ローマ字モード
   - Ctrl+Mでローマ字モード → アルファベットモード

2. **母音単独入力**
   - a → "あ"
   - i → "い"

3. **子音+母音入力**
   - k + a → "か"
   - s + i → "し"

### 6.2 特殊ケース

1. **nの処理**
   - n + a → "な"
   - n + i → "に"
   - n + u → "ぬ"
   - n + e → "ね"
   - n + o → "の"
   - n + k → "ん" + kを新規入力として扱う
   - n + n → "ん"

2. **子音連続入力**
   - k + s → sを新規入力として扱う
   - s + t + a → "た"（最後のt + a）

## 7. 変更履歴

| 日付 | バージョン | 変更内容 | 作成者 |
|------|-----------|---------|--------|
| 2024-XX-XX | 1.0 | 初版作成 | - |

## 8. 参考資料

- HID Usage Tables: https://usb.org/sites/default/files/documents/hut1_22.pdf
- ローマ字入力方式: JIS X 4063:2000

